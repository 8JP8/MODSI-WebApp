
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Data Visualization</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 1000;
        }
        
        #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            font-size: 16px;
            z-index: 1000;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">A carregar configuração VR...</div>
    <div id="error">
        <p>Erro ao carregar configuração VR</p>
        <p id="error-details"></p>
    </div>
    
    <a-scene 
        vr-mode-ui="enabled: true" 
        embedded 
        style="height: 100vh; width: 100vw;"
        background="color: #001122">
        
        <!-- Assets -->
        <a-assets>
            <!-- Define materials -->
        </a-assets>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="1 1 0" color="#ffffff" intensity="0.5"></a-light>
        
        <!-- Camera -->
        <a-entity id="cameraRig" position="0 1.6 3">
            <a-camera 
                look-controls="enabled: true" 
                wasd-controls="enabled: true"
                cursor="rayOrigin: mouse">
            </a-camera>
        </a-entity>
        
        <!-- Ground -->
        <a-plane 
            position="0 0 -4" 
            rotation="-90 0 0" 
            width="10" 
            height="10" 
            color="#333333">
        </a-plane>
        
        <!-- Container for charts -->
        <a-entity id="chartsContainer"></a-entity>
    </a-scene>

    <script>
        console.log('VR Visualization starting...');
        
        // Get room code from URL hash
        const roomCode = window.location.hash.substring(1);
        console.log('Room code from hash:', roomCode);
        
        if (!roomCode) {
            showError('Código da sala não encontrado na URL');
            return;
        }
        
        // Show loading message
        document.getElementById('loading').style.display = 'block';
        
        // Function to show error messages
        function showError(message, details = '') {
            console.error('VR Error:', message, details);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-details').textContent = details;
        }
        
        // Function to create chart visualizations
        function createChartVisualization(chartConfig, index) {
            console.log('Creating chart visualization:', chartConfig);
            
            try {
                const container = document.getElementById('chartsContainer');
                if (!container) {
                    console.error('Charts container not found');
                    return;
                }
                
                // Calculate position offset for multiple charts
                const offsetX = index * 3;
                const position = chartConfig.position || { x: offsetX, y: 1, z: -2 };
                
                // Create chart entity
                const chartEntity = document.createElement('a-entity');
                chartEntity.setAttribute('position', `${position.x + offsetX} ${position.y} ${position.z}`);
                
                // Create different visualizations based on chart type
                if (chartConfig.chartType === 'pizza' || chartConfig.chartType === 'pie') {
                    createPieChart(chartEntity, chartConfig, index);
                } else if (chartConfig.chartType === 'barras' || chartConfig.chartType === 'bar') {
                    createBarChart(chartEntity, chartConfig, index);
                } else if (chartConfig.chartType === 'linha' || chartConfig.chartType === 'line') {
                    createLineChart(chartEntity, chartConfig, index);
                } else {
                    // Default to bar chart
                    createBarChart(chartEntity, chartConfig, index);
                }
                
                // Add title
                const title = document.createElement('a-text');
                title.setAttribute('value', chartConfig.graphname || 'Gráfico');
                title.setAttribute('position', '0 2 0');
                title.setAttribute('align', 'center');
                title.setAttribute('color', '#ffffff');
                title.setAttribute('scale', '2 2 2');
                chartEntity.appendChild(title);
                
                container.appendChild(chartEntity);
                console.log('Chart visualization created successfully');
                
            } catch (error) {
                console.error('Error creating chart visualization:', error);
                showError('Erro ao criar visualização do gráfico', error.message);
            }
        }
        
        function createBarChart(parent, config, index) {
            // Create sample bars for demonstration
            for (let i = 0; i < 5; i++) {
                const bar = document.createElement('a-box');
                const height = Math.random() * 2 + 0.5;
                bar.setAttribute('position', `${i * 0.5 - 1} ${height/2} 0`);
                bar.setAttribute('height', height);
                bar.setAttribute('width', '0.3');
                bar.setAttribute('depth', '0.3');
                bar.setAttribute('color', config.color || '#4CC3D9');
                parent.appendChild(bar);
            }
        }
        
        function createLineChart(parent, config, index) {
            // Create line visualization using connected boxes
            for (let i = 0; i < 5; i++) {
                const point = document.createElement('a-sphere');
                const height = Math.sin(i) + 1;
                point.setAttribute('position', `${i * 0.5 - 1} ${height} 0`);
                point.setAttribute('radius', '0.1');
                point.setAttribute('color', config.color || '#EF2D5E');
                parent.appendChild(point);
            }
        }
        
        function createPieChart(parent, config, index) {
            // Create pie chart using cylinders
            const segments = 4;
            for (let i = 0; i < segments; i++) {
                const segment = document.createElement('a-cylinder');
                const angle = (i / segments) * Math.PI * 2;
                const x = Math.cos(angle) * 0.5;
                const z = Math.sin(angle) * 0.5;
                segment.setAttribute('position', `${x} 0.1 ${z}`);
                segment.setAttribute('height', '0.2');
                segment.setAttribute('radius', '0.3');
                segment.setAttribute('color', `hsl(${i * 90}, 70%, 50%)`);
                parent.appendChild(segment);
            }
        }
        
        // Fetch configuration from API
        async function loadConfiguration() {
            try {
                console.log('Fetching configuration for room:', roomCode);
                
                const response = await fetch(
                    `https://modsi-api-ffhhfgecfdehhscv.spaincentral-01.azurewebsites.net/api/Room/Get/${roomCode}?code=z4tKbNFdaaXzHZ4ayn9pRQokNWYgRkbVkCjOxTxP-8ChAzFuMigGCw==`
                );
                
                console.log('API Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }
                
                const roomData = await response.json();
                console.log('Room data loaded successfully:', roomData);
                
                // Handle the new API format: array with config object
                if (Array.isArray(roomData) && roomData.length > 0) {
                    const configItem = roomData[0];
                    if (configItem.config && configItem.config.charts) {
                        console.log('Processing charts:', configItem.config.charts);
                        configItem.config.charts.forEach((chart, index) => {
                            createChartVisualization(chart, index);
                        });
                    } else {
                        throw new Error('Configuração não contém gráficos válidos');
                    }
                } else {
                    throw new Error('Formato de resposta inválido da API');
                }
                
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                console.log('VR visualization loaded successfully');
                
            } catch (error) {
                console.error('Error loading configuration:', error);
                showError('Erro ao carregar configuração', error.message);
            }
        }
        
        // Wait for A-Frame to be ready, then load configuration
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting configuration load...');
            setTimeout(loadConfiguration, 500); // Small delay to ensure A-Frame is ready
        });
    </script>
</body>
</html>
